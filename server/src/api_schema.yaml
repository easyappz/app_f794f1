openapi: 3.0.3
info:
  title: Social Network API
  version: 0.4.0
  description: |
    REST API scaffold for a social network. Includes JWT-based auth endpoints, user profile endpoints, and posts endpoints with cursor pagination.
    Notes:
      - All errors are centralized and return a unified body: { message, details? }.
      - JWT is returned as a Bearer token in responses; httpOnly cookies are not used.
      - Request body limit is 1MB. Images must be provided and stored only as base64. Max image size is 1MB.
servers:
  - url: http://localhost:3001
    description: Local development server
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    UserPublic:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        displayName:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, email, displayName, createdAt, updatedAt]
    ProfileMe:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        displayName:
          type: string
        bio:
          type: string
        avatarBase64:
          type: string
          description: Image data as base64 (data URL or pure base64). Max 1MB.
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, email, displayName, createdAt, updatedAt]
    ProfilePublic:
      type: object
      properties:
        id:
          type: string
        displayName:
          type: string
        bio:
          type: string
        avatarBase64:
          type: string
          description: Image data as base64 (data URL or pure base64).
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, displayName, createdAt, updatedAt]
    UpdateMeRequest:
      type: object
      properties:
        displayName:
          type: string
          minLength: 2
          maxLength: 50
        bio:
          type: string
          maxLength: 300
        avatarBase64:
          type: string
          description: Base64 image data (with or without data URL prefix). Max 1MB.
      additionalProperties: false
    AuthSuccess:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/UserPublic'
      required: [token, user]
    Post:
      type: object
      properties:
        id:
          type: string
        author:
          $ref: '#/components/schemas/UserPublic'
        text:
          type: string
          minLength: 1
          maxLength: 500
        imageBase64:
          type: string
          nullable: true
          description: Base64 image (data URL or raw base64). Max 1MB.
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, author, text, createdAt, updatedAt]
    CreatePostRequest:
      type: object
      properties:
        text:
          type: string
          minLength: 1
          maxLength: 500
        imageBase64:
          type: string
          description: Optional base64 image data. Max 1MB.
      required: [text]
      additionalProperties: false
    PostsListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        posts:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        nextCursor:
          type: string
          nullable: true
      required: [success, posts]
    ErrorResponse:
      type: object
      description: Unified error format from centralized error handler
      properties:
        message:
          type: string
        details:
          nullable: true
          description: Optional details object
      required: [message]
security:
  - bearerAuth: []
paths:
  /api/status:
    get:
      summary: API status
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
              example:
                status: ok
                timestamp: '2024-01-01T00:00:00.000Z'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth:
    get:
      summary: Placeholder for Auth routes
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  section:
                    type: string
                  message:
                    type: string
              example:
                success: true
                section: auth
                message: Auth placeholder
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/register:
    post:
      summary: Register a new user
      description: Creates a new user, hashes password with bcryptjs, and returns a JWT token (HS256, exp 7d) along with public user data. JWT is returned to be used as Bearer token; cookies are not used.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                displayName:
                  type: string
              required: [email, password, displayName]
            examples:
              valid:
                summary: Valid payload
                value:
                  email: john.doe@example.com
                  password: secret12
                  displayName: John Doe
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSuccess'
              examples:
                success:
                  value:
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    user:
                      id: 65f0b1d9b0c5a1f1c2d3e4f5
                      email: john.doe@example.com
                      displayName: John Doe
                      createdAt: '2025-01-01T00:00:00.000Z'
                      updatedAt: '2025-01-01T00:00:00.000Z'
        '400':
          description: Validation error (invalid email, password too short, invalid displayName, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  value:
                    message: Invalid email format
                shortPassword:
                  value:
                    message: Password must be at least 6 characters
        '409':
          description: Email already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                conflict:
                  value:
                    message: Email already in use
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/login:
    post:
      summary: Login with email and password
      description: Verifies credentials and returns a JWT token (HS256, exp 7d) with public user data. Token must be used as Bearer.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
              required: [email, password]
            examples:
              valid:
                summary: Valid payload
                value:
                  email: john.doe@example.com
                  password: secret12
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSuccess'
              examples:
                success:
                  value:
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    user:
                      id: 65f0b1d9b0c5a1f1c2d3e4f5
                      email: john.doe@example.com
                      displayName: John Doe
                      createdAt: '2025-01-01T00:00:00.000Z'
                      updatedAt: '2025-01-01T00:00:00.000Z'
        '400':
          description: Validation error (missing or invalid fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingFields:
                  value:
                    message: Invalid email format
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid:
                  value:
                    message: Invalid email or password
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/users/me:
    get:
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/ProfileMe'
        '401':
          description: Unauthorized (missing or invalid Bearer token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Update current user profile
      description: Update displayName, bio and avatarBase64 (<= 1MB). Strings are normalized and trimmed.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMeRequest'
            examples:
              example:
                value:
                  displayName: Jane Doe
                  bio: Hello, I love coding!
                  avatarBase64: data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/ProfileMe'
        '400':
          description: Validation error (invalid lengths or avatarBase64 > 1MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                bigAvatar:
                  value:
                    message: avatarBase64 exceeds 1MB limit
                    details:
                      sizeBytes: 1500000
                      maxBytes: 1048576
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/users/{id}:
    get:
      summary: Get public profile by user id
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Public user profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/ProfilePublic'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  value:
                    message: User not found
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/users/{id}/posts:
    get:
      summary: List posts by user id (public)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: cursor
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: ISO date-time string. Returns items created before this timestamp.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: List of user's posts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostsListResponse'
              examples:
                success:
                  value:
                    success: true
                    posts:
                      - id: 66a1b2c3d4e5f6a7b8c9d0e1
                        text: Hello world!
                        imageBase64: null
                        createdAt: '2025-01-01T00:00:00.000Z'
                        updatedAt: '2025-01-01T00:00:00.000Z'
                        author:
                          id: 65f0b1d9b0c5a1f1c2d3e4f5
                          email: john.doe@example.com
                          displayName: John Doe
                          createdAt: '2025-01-01T00:00:00.000Z'
                          updatedAt: '2025-01-01T00:00:00.000Z'
                    nextCursor: '2024-12-31T23:59:59.000Z'
        '400':
          description: Validation error (invalid cursor or limit)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/posts:
    get:
      summary: List public feed (cursor pagination)
      parameters:
        - name: cursor
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: ISO date-time string. Returns items created before this timestamp.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: List of posts (public feed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostsListResponse'
              examples:
                success:
                  value:
                    success: true
                    posts:
                      - id: 66a1b2c3d4e5f6a7b8c9d0e1
                        text: First post!
                        imageBase64: null
                        createdAt: '2025-01-01T00:00:00.000Z'
                        updatedAt: '2025-01-01T00:00:00.000Z'
                        author:
                          id: 65f0b1d9b0c5a1f1c2d3e4f5
                          email: john.doe@example.com
                          displayName: John Doe
                          createdAt: '2025-01-01T00:00:00.000Z'
                          updatedAt: '2025-01-01T00:00:00.000Z'
                    nextCursor: '2024-12-31T23:59:59.000Z'
        '400':
          description: Validation error (invalid cursor or limit)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Create a new post
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePostRequest'
            examples:
              example:
                value:
                  text: My first post!
                  imageBase64: data:image/png;base64,iVBORw0KGgoAAAANSUhEUg...
      responses:
        '201':
          description: Post created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  post:
                    $ref: '#/components/schemas/Post'
              examples:
                success:
                  value:
                    success: true
                    post:
                      id: 66a1b2c3d4e5f6a7b8c9d0e1
                      text: My first post!
                      imageBase64: null
                      createdAt: '2025-01-01T00:00:00.000Z'
                      updatedAt: '2025-01-01T00:00:00.000Z'
                      author:
                        id: 65f0b1d9b0c5a1f1c2d3e4f5
                        email: john.doe@example.com
                        displayName: John Doe
                        createdAt: '2025-01-01T00:00:00.000Z'
                        updatedAt: '2025-01-01T00:00:00.000Z'
        '400':
          description: Validation error (text length or imageBase64 > 1MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                bigImage:
                  value:
                    message: imageBase64 exceeds 1MB limit
                    details:
                      sizeBytes: 1500000
                      maxBytes: 1048576
        '401':
          description: Unauthorized (missing or invalid Bearer token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
